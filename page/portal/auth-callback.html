<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>กำลังเข้าสู่ระบบ... - PAM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="../../function/shared/js/supabase-config.js"></script>
    <style>
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .spinner {
            animation: spin 0.8s linear infinite;
        }
    </style>
</head>

<body class="bg-white min-h-screen flex items-center justify-center">

    <div class="text-center">
        <svg class="spinner w-10 h-10 text-blue-500 mx-auto mb-4" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
        </svg>
        <p id="statusText" class="text-gray-600 font-medium">กำลังตรวจสอบ...</p>
    </div>

    <script>
        (async function () {
            const ALLOWED_DOMAIN = '@pattayaaviation.com';
            const db = window.supabaseClient;

            if (!db) {
                document.getElementById('statusText').textContent = 'ไม่สามารถเชื่อมต่อฐานข้อมูลได้';
                return;
            }

            // Supabase แปลง URL hash → session อัตโนมัติ
            const { data: { session }, error } = await db.auth.getSession();

            if (error || !session) {
                document.getElementById('statusText').textContent = 'เกิดข้อผิดพลาด กรุณาลองใหม่';
                setTimeout(() => { window.location.href = '../../page/home/main/pam.html'; }, 2000);
                return;
            }

            const user = session.user;

            // บันทึก sessionStorage
            sessionStorage.setItem('user', JSON.stringify({
                name: user.user_metadata?.full_name || user.email,
                email: user.email,
                id: user.id
            }));

            // ── Domain check ─────────────────────────────────────────────────────
            if (!user.email.endsWith(ALLOWED_DOMAIN)) {
                // Auto-reject: domain ไม่ใช่ pattayaaviation.com
                await db.from('portal_users').upsert({
                    email: user.email,
                    name: user.user_metadata?.full_name || user.email,
                    ms_id: user.user_metadata?.provider_id || '',
                    status: 'rejected',
                    last_login: new Date().toISOString()
                }, { onConflict: 'email', ignoreDuplicates: false });

                await db.auth.signOut();
                sessionStorage.removeItem('user');
                document.getElementById('statusText').textContent = 'อีเมลนี้ไม่ได้รับอนุญาตให้เข้าใช้ระบบ';
                setTimeout(() => { window.location.href = '../../page/home/main/pam.html'; }, 2500);
                return;
            }

            // ── ตรวจสอบว่า user มีอยู่แล้วหรือเปล่า (ไม่ reset status ถ้า login ซ้ำ) ──
            const { data: existing } = await db
                .from('portal_users')
                .select('status')
                .eq('email', user.email)
                .maybeSingle();

            if (!existing) {
                // ครั้งแรก → insert status: pending รอ admin อนุมัติ
                await db.from('portal_users').insert({
                    email: user.email,
                    name: user.user_metadata?.full_name || user.email,
                    ms_id: user.user_metadata?.provider_id || '',
                    status: 'pending',
                    last_login: new Date().toISOString()
                });
            } else {
                // login ซ้ำ → อัปเดตแค่ last_login ไม่แตะ status
                await db.from('portal_users')
                    .update({ last_login: new Date().toISOString() })
                    .eq('email', user.email);
            }

            const status = existing?.status || 'pending';

            // ── Redirect ตาม status ───────────────────────────────────────────────
            if (status === 'approved') {
                window.location.href = '../../page/portal/index.html';
            } else {
                // pending หรือ rejected → หน้ารอการอนุมัติ
                window.location.href = '../../page/portal/pending.html';
            }

        })();
    </script>

</body>

</html>